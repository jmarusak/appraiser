<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Appraiser</title>
  <!-- script src="https://unpkg.com/htmx.org@2"></script -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50">
  <div class="container mx-auto p-8 h-full">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="bg-gray-50 p-6 rounded-lg">
        <h2 class="text-xl font-bold text-gray-800">Input</h2>
        <div class="mb-6 mt-4">
          <div class="mx-auto" id="image-preview" class="border-solid border-2 border-gray-400 rounded-lg w-64 h-64 flex items-center justify-center p-0 hover:bg-gray-100 transition duration-300 bg-white">
              <img src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*u0s9_nRBMojok3S043wBcg.png" alt="Uploaded Image" class="max-w-full h-full mx-auto object-contain">
          </div>
          <label
            for="description"
            class="block text-gray-700 text-sm font-bold mb-2"
            >Description:</label
          >
          <textarea
            id="description"
            name="description"
            rows="3"
            class="bg-white shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500/50"
          ></textarea>
        </div>
        <button
          type="submit"
          id="upload-image-button"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
        >
          Upload Image
        </button>
        <button
          type="submit"
          id="estimate-value-button"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50"
        >
          Estimate Value
        </button>
      </div>
      <div class="bg-gray-50 p-6 rounded-lg">
        <h2 class="text-xl font-bold text-gray-800">Result</h2>
        <div id="results" class="h-full">
          <!-- Valuation results will be displayed here -->
        </div>
      </div>
    </div>
  </div>
  <script>
    let image_uri = null;
    let image_data = null;
    let content_type = null;

    const estimateValueButton = document.getElementById('estimate-value-button');
    estimateValueButton.addEventListener('click', function (event) {
      const description = document.getElementById('description').value;
      const resultsDiv = document.getElementById('results');
      if (!description) {
        alert('Please enter a description.');
        event.preventDefault();
      } else {
        fetch('/appraise', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            description: description,
            image_uri: image_uri,
            image_data: image_data,
            content_type: content_type
          })
        })
        .then(response => response.json())
        .then(data => {
            
            // Format the currency
            function formatCurrency(value, currency) {
              return new Intl.NumberFormat("en-US", {
                style: "currency",
                currency: currency,
                minimumFractionDigits: 2,
                maximumFractionDigits: 2,
              }).format(value);
            }

            const formattedValue = formatCurrency(
              data.estimated_value,
              "CAD"
            );

            let resultsHTML = `
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <p class="font-semibold">Estimated Value:</p> <p class="text-2xl text-blue-600">${formattedValue}</p>
                        <br>
                        <p class="font-semibold">Product Name:</p> <p class="text-sm text-gray-700">${data.product_name}</p>
                        <br>
                        <p class="font-semibold">Reasoning:</p> <p class="text-sm text-gray-700">${data.reasoning}</p>
                    </div>
            `;

            if (
              data.search_urls &&
              data.search_urls.length > 0 &&
              data.search_urls[0] !== "N/A"
            ) {
              resultsHTML += `
                        <br>
                        <p class="font-semibold">Sources:</p>
                        <ul class="text-sm list-disc list-inside ml-4">`;
              data.search_urls.forEach((url) => {
                resultsHTML += `<li><a href="${url}" target="_blank" class="text-blue-600 hover:underline">${url}</a></li>`;
              });
              resultsHTML += `</ul>`;
            }
            resultsHTML += `</div>`;

          resultsDiv.innerHTML = resultsHTML;
        })
        .catch(error => {
          console.error('Error:', error);
          resultsDiv.innerHTML = 'An error occurred.';
        });
      }
    });

    const uploadImageButton = document.getElementById('upload-image-button');
    uploadImageButton.addEventListener('click', function (event) {
      event.preventDefault(); // Prevent default form submission

      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*'; // Accept only image files

      fileInput.addEventListener('change', function (event) {
        const file = event.target.files[0];
        if (file) {
          const formData = new FormData();
          formData.append('image_file', file);

          fetch('/upload-image', {
            method: 'POST',
            body: formData,
          })
          .then(response => response.json())
          .then(data => {
            image_uri = data.image_uri;
            image_data = data.image_data;
            content_type = data.content_type;
            const imagePreview = document.getElementById('image-preview');
            imagePreview.innerHTML = `<img src="${data.image_data}" alt="Uploaded Image" class="max-w-full h-full mx-auto object-contain">`;
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error uploading image.');
          });
        }
      });

      fileInput.click(); // Programmatically trigger the file input
    });
  </script>
</body>
</html>
